<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knessight</title>
    <link rel="stylesheet" href="try.css">
</head>

<body>
    <div class="search-container">
        <input type="text" class="search-box" placeholder="חפש כאן..." id="searchInput">
    </div>
    <div class="results-container">
        <ul id="resultsList">
        </ul>
    </div>
</body>

<script>
    function shuffle(array) {
        let currentIndex = array.length;

        // While there remain elements to shuffle...
        while (currentIndex != 0) {

            // Pick a remaining element...
            let randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;

            // And swap it with the current element.
            [array[currentIndex], array[randomIndex]] =
                [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    const container = document.getElementById('resultsList');
    const searchInput = document.getElementById('searchInput');
    const layer_cols = 55;
    const layer_rows = 25;
    const layer_size = layer_cols * layer_rows;
    const layers = [
        { name: '2', free: Array.from({ length: layer_size }, (_, i) => i).reverse() },
        { name: '3', free: Array.from({ length: layer_size }, (_, i) => i).reverse() }
    ];

    var tmp = [];
    const center = {
        col: Math.floor(layer_cols / 2),
        row: Math.floor(layer_rows / 2)
    };
    for (let i = 0; i < layer_rows; i++) {
        for (let j = 0; j < layer_cols; j++) {
            tmp.push({
                index: i * layer_cols + j,
                dist: Math.max(Math.abs(j - center.col), Math.abs(i - center.row))
            });
        }
    }
    shuffle(tmp);
    tmp.sort((a, b) => a.dist - b.dist);
    const indexes = tmp.map((item) => item.index);

    let itemsElements = [];

    // get items for client_data/mks.csv
    async function getItems() {
        let items = [];
        await fetch('client_data/mks.csv')
            .then(response => response.text())
            .then(data => {
                const lines = data.split('\n').slice(1) // Remove the header line
                    .slice(0, 500) // Limit to 200 items for performance
                    ;
                items = lines
                    .map(line => line.split(','))
                    .map(parts => {
                        return {
                            id: parseInt(parts[0]),
                            knessetSiteId: parseInt(parts[3]),
                            name: parts[1] + " " + parts[2],
                            imageUrl: parts[4]
                        }
                    });
            })
            .catch(error => console.error('Error fetching items:', error));
        itemsElements = items.map((item, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <a href="/mks/${item.id}">
                    <img src="${item.imageUrl}" alt="${item.name}">
                    <span class="name">${item.name}</span>
                </a>
            `;
            li.setAttribute('layer', 2); // Default layer is 2
            li.style.setProperty('--index', indexes[index]);
            container.appendChild(li);
            return { item: item, li: li, layer: 2, index: layers[0].free.pop() };
        });
    }

    searchInput.addEventListener('input', async (e) => {
        const searchTerm = e.target.value;
        const from2to3 = [];
        const from3to2 = [];
        itemsElements.forEach(i => {
            const layer2 = searchTerm === "" || i.item.name.includes(searchTerm);
            if (i.layer === 3 && layer2) {
                from3to2.push(i);
                layers[1].free.push(i.index);
            }
            else if (i.layer != 3 && !layer2) {
                from2to3.push(i);
                layers[0].free.push(i.index);
            }
        });
        layers[0].free.sort((a, b) => b - a);
        layers[1].free.sort((a, b) => b - a);
        for (const i of from2to3) {
            i.layer = 3;
            const index = layers[1].free.pop();
            i.index = index;
            i.li.setAttribute('layer', 3);
            i.li.style.setProperty('--index', indexes[index]);
        }
        let index = 0;
        for (const i of from3to2) {
            i.layer = 2;
            i.index = index;
            i.li.setAttribute('layer', 2);
            i.li.style.setProperty('--index', indexes[index++]);
        }

        // // if there are <= 50 items in layer 2, move them to layer 1
        // if (layers[0].free.length > layer_size - 50) {
        //     container.querySelectorAll('li[layer="2"], li[layer="1"]').forEach((li, index) => {
        //         li.setAttribute('layer', 1);
        //         li.style.setProperty('--index', indexes[index]);
        //     });
        // }
        // else {
        //     container.querySelectorAll('li[layer="1"]').forEach((li) => {
        //         li.setAttribute('layer', 2);
        //         li.style.setProperty('--index', indexes[layers[1].free.pop()]);
        //     });
        // }
    });

    document.addEventListener('mousemove', async (e) => {
        const x = (e.clientX / window.innerWidth - 0.5) * 10;
        const y = (e.clientY / window.innerHeight - 0.5) * 10;

        container.style.transform = `rotateY(${x}deg) rotateX(${-y}deg)`;
        // container.style.setProperty('--rotate-x', `${x}deg`);
        // container.style.setProperty('--rotate-y', `${-y}deg`);
    });

    getItems();

</script>

</html>